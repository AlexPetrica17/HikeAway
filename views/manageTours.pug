extends base

mixin navItem(link, text, icon, active)
  li(class=`${active ? 'side-nav--active' : ''}`)
    a(href=`${link}`)
      svg
        use(xlink:href=`img/icons.svg#icon-${icon}`)
      | #{text}

block content
  main.main
    .user-view
      nav.user-view__menu
        ul.side-nav
          +navItem('/me', 'Setări', 'settings')
          +navItem('/my-tours', 'Rezervările mele', 'briefcase')
          +navItem('/my-reviews', 'Recenziile mele', 'star')
          +navItem('/billing', 'Facturare', 'credit-card')
        - if (user.role === 'admin')
          .admin-nav
            h5.admin-nav__heading Admin
            ul.side-nav
              +navItem('/manage-tours', 'Gestionare tururi', 'map', true)
              +navItem('/manage-reviews', 'Gestionare recenzii', 'star')
              +navItem('/manage-bookings', 'Gestionare rezervări', 'briefcase')
              +navItem('/manage-users', 'Gestionare utilizatori', 'users')

      .user-view__content
        .user-view__form-container
          h2.heading-secondary.ma-bt-md= tourToEdit ? 'Editează tur' : 'Adaugă tur nou'

          form.form.form-tour-data#tour-form(
            data-mode=tourToEdit ? 'edit' : 'create',
            data-id=(tourToEdit && tourToEdit._id) || '',
            data-locations=(tourToEdit && JSON.stringify(tourToEdit.locations)) || '[]',
            enctype='multipart/form-data'
          )
            .form__group
              label.form__label(for='name') Nume tur
              input#name.form__input(type='text', name='name', value=(tourToEdit && tourToEdit.name) || '', required)

            .form__group
              label.form__label(for='duration') Durată (zile)
              input#duration.form__input(type='number', name='duration', value=(tourToEdit && tourToEdit.duration) || '', required)

            .form__group
              label.form__label(for='maxGroupSize') Dimensiune maximă grup
              input#maxGroupSize.form__input(type='number', name='maxGroupSize', value=(tourToEdit && tourToEdit.maxGroupSize) || '', required)

            .form__group
              label.form__label(for='difficulty') Dificultate
              select#difficulty.form__input(name='difficulty', required)
                option(value='usor', selected=(tourToEdit && tourToEdit.difficulty === 'usor')) Usor
                option(value='mediu', selected=(tourToEdit && tourToEdit.difficulty === 'mediu')) Mediu
                option(value='dificil', selected=(tourToEdit && tourToEdit.difficulty === 'dificil')) Dificil

            .form__group
              label.form__label(for='price') Preț (RON)
              input#price.form__input(type='number', name='price', value=(tourToEdit && tourToEdit.price) || '', required)

            .form__group
              label.form__label(for='summary') Descriere scurtă
              textarea#summary.form__input(name='summary', required)= (tourToEdit && tourToEdit.summary) || ''

            .form__group
              label.form__label(for='description') Descriere detaliată
              textarea#description.form__input(name='description', rows='6', required placeholder='Ex: Acest tur include trasee montane, ghid profesionist...')= (tourToEdit && tourToEdit.description) || ''

            .form__group
              label.form__label(for='startDate') Dată de start
              input#startDate.form__input(type='date', name='startDates', value=(tourToEdit && tourToEdit.startDates && tourToEdit.startDates[0] && new Date(tourToEdit.startDates[0]).toISOString().slice(0, 10)) || '', required)

            .form__group
              label.form__label(for='leadGuide') Ghid principal
              select#leadGuide.form__input(name='leadGuide' required)
                option(value='') -- Selectează un ghid --
                each user in users
                  if user.role === 'lead-guide'
                    - const isLead = tourToEdit && tourToEdit.guides && tourToEdit.guides[0] && (tourToEdit.guides[0]._id?.toString?.() || tourToEdit.guides[0].toString?.()) === user._id.toString()
                    option(value=user._id, selected=isLead)= user.name

            .form__group
              label.form__label(for='guides') Ghiduri secundare
              select#guides.form__input(name='guides' multiple)
                each user in users
                  if user.role === 'guide'
                     if !(tourToEdit && tourToEdit.guides && tourToEdit.guides[0] == user._id)
                      - const isSecondary = tourToEdit && tourToEdit.guides && tourToEdit.guides.slice(1).some(g => (g._id?.toString?.() || g.toString?.()) === user._id.toString())
                      option(value=user._id, selected=isSecondary)= user.name
                        
            .form__group
              label.form__label(for='imageCover') Imagine principală
              if tourToEdit && tourToEdit.imageCover
                img.form__user-photo(src=`/img/tours/${tourToEdit.imageCover}`, alt='Imagine actuală', style='max-width: 200px; margin-bottom: 1rem; border-radius: 8px;')
              input#imageCover.form__upload(type='file', name='imageCover', accept='image/*')
              label(for='imageCover', style='cursor:pointer; color:#f97316;') Alege o nouă imagine

            .form__group
              label.form__label(for='images') Alte imagini
              if tourToEdit && tourToEdit.images && tourToEdit.images.length
                .image-preview-grid(style='display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem;')
                  each imgName in tourToEdit.images
                    img(src=`/img/tours/${imgName}`, alt='Imagine existentă', style='width: 120px; height: 80px; border-radius: 6px; object-fit: cover;')
              input#images.form__upload(type='file', name='images', multiple, accept='image/*')
              label(for='images', style='cursor:pointer; color:#f97316;') Alege imagini suplimentare

            .form__group
              label.form__label(for='startLocationAddress') Adresa locației de start
              input#startLocationAddress.form__input(type='text', name='startLocation.address', value=(tourToEdit && tourToEdit.startLocation.address) || '', required)

            .form__group
              label.form__label(for='startLocationLat') Latitudine
              input#startLocationLat.form__input(type='number', name='startLocation.coordinates[1]', step='any', value=(tourToEdit && tourToEdit.startLocation.coordinates[1]) || '', required)

            .form__group
              label.form__label(for='startLocationLng') Longitudine
              input#startLocationLng.form__input(type='number', name='startLocation.coordinates[0]', step='any', value=(tourToEdit && tourToEdit.startLocation.coordinates[0]) || '', required)

            .form__group
              label.form__label(for='startLocationDescription') Descriere locație de start
              input#startLocationDescription.form__input(type='text', name='startLocation.description', value=(tourToEdit && tourToEdit.startLocation.description) || '', required)

            .form__group
              label.form__label(for='locationCount') Număr locații suplimentare
              input#locationCount.form__input(
                type='number',
                min='0',
                value=(tourToEdit && tourToEdit.locations && tourToEdit.locations.length) || 0
              )

            #locationsContainer


            .form__group.right
              button.btn.btn--green.btn--small(type='submit')
                span= tourToEdit ? 'Salvează modificările' : 'Adaugă tur'

          .line &nbsp;

          .tours-table-container
            h2.heading-secondary.ma-bt-md Tururi existente

            table.table(style='width: 100%; text-align: center; border-collapse: collapse;')
              thead
                tr(style='background-color: #fff3e0; color: #f97316; font-weight: bold;')
                  th(style='padding: 1rem; border-bottom: 1px solid #f97316;') Nume
                  th(style='padding: 1rem; border-bottom: 1px solid #f97316;') Durată
                  th(style='padding: 1rem; border-bottom: 1px solid #f97316;') Grup
                  th(style='padding: 1rem; border-bottom: 1px solid #f97316;') Dificultate
                  th(style='padding: 1rem; border-bottom: 1px solid #f97316;') Preț
                  th(style='padding: 1rem; border-bottom: 1px solid #f97316;') Acțiuni
              tbody
                if tours.length
                  each tour in tours
                    tr(style='border-bottom: 1px solid #eee;')
                      td(style='padding: 1rem;')= tour.name
                      td(style='padding: 1rem;')= `${tour.duration} zile`
                      td(style='padding: 1rem;')= tour.maxGroupSize
                      td(style='padding: 1rem; text-transform: capitalize;')= tour.difficulty
                      td(style='padding: 1rem;')= `${tour.price} RON`
                      td(style='padding: 1rem; display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap;')
                        a.btn.btn--green.btn--small(href='/manage-tours?editId=' + tour._id)
                          span Editează
                        button.btn.btn--red.btn--small.delete-btn(type='button', data-id=tour._id)
                          span Șterge
                else
                  tr
                    td(colspan='6', style='padding: 2rem;') Nu există tururi disponibile momentan.
